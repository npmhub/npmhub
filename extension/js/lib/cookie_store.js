var CookieStore;try{CookieStore={_db:null,_initializedTables:[],init:function(d,c,g){if(!c){c=[TableNames.USER_COOKIES];}try{this._db=openDatabase("crossrider_cookies_"+d,1,"Crossrider Cookies Store",50*1024*1024);}catch(f){Reports.error(new ErrorMessage(f,"CookieStore->_init"));return;}var b=c.length;for(var a=0;a<c.length;++a){(function(i,e,h){i.transaction(function(j){j.executeSql("create table if not exists "+h[e]+"(name varchar(255) primary key, value longtext, created_at datetime default (datetime('now','localtime')), expires datetime)",[],function(){i.transaction(function(k){CookieStore._initializedTables.push(h[e]);k.executeSql("delete from "+h[e]+" where datetime(expires) < datetime('now')",[],function(){b--;if(b==0){g();}},function(){Crossrider.Utils.internalDebug("removing expired cookies on init",arguments);});});},function(){Crossrider.Utils.internalDebug("crate tables on init",arguments);});});})(this._db,a,c);}},getTableName:function(a){for(var b in TableNames){if(b.toLowerCase().indexOf("length")<0){if(TableNames[b]===a){return a;}}}return TableNames.USER_COOKIES;},_isValidTableName:function(b){var a=false;if(b&&(typeof b==="string")){for(var c in TableNames){if(c.toLowerCase().indexOf("length")<0){if(TableNames[c]===b){a=true;break;}}}}return a;},getCookie:function(b,e,f){if(IsValidTableName(b)){var c=new Date();var a=this;var d=null;this._db.transaction((function(g){return function(h){h.executeSql("select name,value,expires from "+b+" where ( datetime(expires) >= datetime('now')  AND name == ? )",[e],function(i,k){if(k&&k.rows&&k.rows.length>0){var l=k.rows.item(0);var j=JSON.parse(l.value);d={value:j.value,expires:g._formatDateFromDateTime(l.expires)};}if(f&&(typeof f==="function")){f(d);}}.bind(this),function(){f(null);Crossrider.Utils.internalDebug("getCookies error, table name:"+currentTable,arguments);});};})(a));}},getCookies:function(h,g){var d={},f="",a=0,b=this;if(!g){g=[TableNames.USER_COOKIES];}for(var e=0;e<g.length;++e){var c=new Date();f=g[e];this._db.transaction((function(j,i){return function(k){k.executeSql("select name,value,expires from "+j+" where datetime(expires) >= datetime('now')",[],function(l,n){var o={};for(var m=0;m<n.rows.length;m++){var p=n.rows.item(m),q=JSON.parse(p.value);o[p.name]={value:q.value,expires:i._formatDateFromDateTime(p.expires)};}d[j]=o;a++;if((a==g.length)&&h){h(d);}}.bind(this),function(){Crossrider.Utils.internalDebug("getCookies error, table name:"+j,arguments);});};})(f,b));}},getKeys:function(h,g){var d={},f="",a=0,b=this;if(!g){g=[TableNames.USER_COOKIES];}for(var e=0;e<g.length;++e){var c=new Date();f=g[e];this._db.transaction((function(j,i){return function(k){k.executeSql("select name from "+j+" where datetime(expires) >= datetime('now')",[],function(l,n){var o=[];for(var m=0;m<n.rows.length;m++){var p=n.rows.item(m);o.push(p.name);}d[j]=o;a++;if((a==g.length)&&h){h(d);}}.bind(this),function(){Crossrider.Utils.internalDebug("getKeys error, table name:"+j,arguments);});};})(f,b));}},setCookie:function(c,e,a,b,f,d){b=this.getTableName(b);this._db.transaction(function(g){var i=this._formatDateTimeFromDate(a);var h=JSON.stringify({value:e});g.executeSql("replace into "+b+" (name,value,expires) values(?,?,?)",[c,h,i],f,function(){Crossrider.Utils.internalDebug(b+" set failed",arguments);});}.bind(this));},updateCookieExpiration:function(c,a,b,d){b=this.getTableName(b);this._db.transaction(function(e){var f=this._formatDateTimeFromDate(a);e.executeSql("update "+b+" set expires == ? where name == ?",[f,c],d,function(){Crossrider.Utils.internalDebug(b+" update cookie expiration failed",arguments);});}.bind(this));},unsetCookie:function(b,a,c){a=this.getTableName(a);this._db.transaction(function(d){d.executeSql("delete from "+a+" where name = ?",[b],c,function(){Crossrider.Utils.internalDebug(a+" unset failed",arguments);});});},removeExpiredCookies:function(a,b){a=this.getTableName(a);if(CookieStore._initializedTables.indexOf(a)<0){b();return;}this._db.transaction(function(c){var d=new Date();c.executeSql("select * from "+a+" where datetime(expires) < datetime('now', 'localtime')",[],function(h,f){if(f.rows.length==0){b([]);return;}var g=[];for(var e=0;e<f.rows.length;e++){g.push(f.rows.item(e).name);}c.executeSql("delete from "+a+" where datetime(expires) < datetime('now', 'localtime')",[],function(){b(g);},function(){Crossrider.Utils.internalDebug("deleting expired "+a+" failed",arguments);});},function(){Crossrider.Utils.internalDebug("fetching expired "+a+" failed",arguments);});});},clearDataWithExcludedFields:function(b,c){if(c.length===0){var a=true;this.clearData(b,a);}else{var d=" name <> ";var e="delete from "+this.getTableName(b)+" where";c.forEach(function(f){e+=d+"'"+f+"' and";});e=e.slice(0,e.lastIndexOf("and")-1);this._db.transaction(function(f){f.executeSql(e,[],function(){},function(){var g=new Error("DB query execution fail");UserReport.error(new ErrorMessage(g,"clearDataWithExcludedFields"));});});}},clearData:function(b,a,d){b=this.getTableName(b);var c=a?"delete from ":"drop table ";this._db.transaction(function(e){e.executeSql(c+b,[],function(){if(d&&typeof d==="function"){d();}},function(){Crossrider.Utils.internalDebug(b+" clearing failed",arguments);});});},_formatDateTimeFromDate:function(f){f=new Date(f);var e=f.getMonth()+1,b=f.getDate();var a=f.getHours(),d=f.getMinutes(),c=f.getSeconds();if(e<10){e="0"+e.toString();}if(b<10){b="0"+b.toString();}if(a<10){a="0"+a.toString();}if(d<10){d="0"+d.toString();}if(c<10){c="0"+c.toString();}return[[f.getFullYear(),e,b].join("-"),[a,d,c].join(":")].join(" ");},_formatDateFromDateTime:function(d){var c=d.split(" ");var a=c[0].split("-");var b=c[1].split(":");return new Date(parseInt(a[0],10),parseInt(a[1],10)-1,parseInt(a[2],10),parseInt(b[0],10),parseInt(b[1],10),parseInt(b[2],10)).getTime();}};}catch(err){Reports.error(new ErrorMessage(err,"CookieStore init"));}
